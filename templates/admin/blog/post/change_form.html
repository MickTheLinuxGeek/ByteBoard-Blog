{% extends "admin/change_form.html" %}
{% load i18n admin_urls %}

{% block extrahead %}
{{ block.super }}
<style>
    .markdown-preview {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    .markdown-preview h2 {
        margin-top: 0;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .preview-content {
        padding: 10px;
        background-color: white;
        border: 1px solid #eee;
        border-radius: 3px;
        min-height: 100px;
    }
    /* Style for code blocks */
    .preview-content pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
    }
    .preview-content code {
        font-family: monospace;
    }
</style>
{% endblock %}

{% block after_field_sets %}
{{ block.super }}
{% if adminform.form.instance.pk and original.content %}
<div class="markdown-preview">
    <h2>{% trans "Content Preview" %}</h2>
    <div class="preview-content" id="markdown-preview">
        <!-- Preview content will be loaded here -->
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the content textarea
        const contentTextarea = document.getElementById('id_content');
        const previewDiv = document.getElementById('markdown-preview');
        
        // Function to update preview
        function updatePreview() {
            // Get the content
            const content = contentTextarea.value;
            
            // Send content to server for rendering
            fetch('/admin/blog/post/preview/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: 'content=' + encodeURIComponent(content)
            })
            .then(response => response.text())
            .then(html => {
                previewDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                previewDiv.innerHTML = '<p>Error loading preview</p>';
            });
        }
        
        // Update preview on load
        updatePreview();
        
        // Update preview when content changes
        contentTextarea.addEventListener('input', updatePreview);
    });
</script>
{% endif %}
{% endblock %}